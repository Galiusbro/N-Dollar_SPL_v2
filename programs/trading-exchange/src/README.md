# Trading Exchange - Реструктуризированный проект

## Структура проекта

```
trading_exchange/
├── lib.rs             # Точка входа программы, объявление модулей и инструкций
├── constants.rs       # Константы для проекта
├── errors.rs          # Определения ошибок программы
├── state.rs           # Определения состояний (аккаунтов)
├── contexts/          # Контексты инструкций
│   ├── mod.rs         # Экспорт всех контекстов
│   ├── initialize.rs  # Контексты для инициализации
│   └── swap.rs        # Контексты для операций свопа
├── instructions/      # Реализация инструкций
│   ├── mod.rs         # Экспорт всех инструкций
│   ├── initialize.rs  # Инструкции инициализации
│   ├── swap.rs        # Инструкции свопа
│   └── utils.rs       # Вспомогательные функции
└── math/              # Математические функции
    └── mod.rs         # Функции для расчетов с бондинговыми кривыми
```

## Описание модулей

### 1. `lib.rs`

Основной файл программы, содержит объявление ID программы, подключение модулей и определение инструкций (entrypoints).

### 2. `constants.rs`

Содержит все константы, используемые в программе:

- Параметры для проверок (минимальное количество SOL для комиссий)
- Проценты комиссий и поправки на слиппедж
- Семена для генерации PDA
- Дискриминаторы для CPI вызовов

### 3. `errors.rs`

Определяет все возможные ошибки программы биржи обмена.

### 4. `state.rs`

Содержит определения структур данных:

- `ExchangeData` - Данные об обменных операциях
- `TradingExchange` - Данные о торговой бирже
- `ControlState` - Данные о состоянии программы

### 5. `contexts/`

Директория с контекстами (аккаунтами) для каждой инструкции:

- `initialize.rs`: Контексты для инициализации биржи и связанных аккаунтов
- `swap.rs`: Контексты для операций обмена (свопа) между различными токенами

### 6. `instructions/`

Директория с реализациями инструкций:

- `initialize.rs`: Логика инициализации биржи и связанных аккаунтов
- `swap.rs`: Логика обмена токенов, включая взаимодействие с бондинговыми кривыми и ликвидностью
- `utils.rs`: Вспомогательные функции для проверок, расчетов и CPI вызовов

### 7. `math/`

Директория с математическими функциями для расчетов:

- Расчет стоимости токенов в N-Dollar
- Расчет количества токенов для заданного количества N-Dollar
- Расчет текущей цены токена на бондинговой кривой

## Выполненная реструктуризация

1. Разделены логические блоки:
   - Состояния и структуры данных
   - Контексты инструкций
   - Реализация инструкций
   - Математические расчеты
   - Константы и ошибки
2. Улучшена организация кода:
   - Каждый модуль отвечает за конкретный аспект программы
   - Уменьшен размер отдельных файлов
   - Улучшена навигация по коду
   - Вынесены литералы в константы
3. Выделены вспомогательные функции:

   - Проверка авторизации через admin_control
   - Получение процента комиссии
   - Создание CPI инструкций
   - Математические расчеты с бондинговыми кривыми

4. Сохранена вся функциональность:
   - Все инструкции работают так же, как и раньше
   - Логика осталась неизменной
   - Интеграция с другими программами (bonding_curve, liquidity_manager, admin_control)

## Ключевые особенности программы

1. **Обмен токенов через бондинговые кривые:**

   - Расчет стоимости токенов в N-Dollar
   - Учет влияния объема транзакции на цену (слиппедж)
   - Поддержка различных степеней кривых

2. **Интеграция с Liquidity Manager:**

   - Обмен N-Dollar на SOL
   - Обмен SOL на N-Dollar
   - Cross-program invocation (CPI) для взаимодействия

3. **Административные функции:**

   - Инициализация биржи и контрольных аккаунтов
   - Активация/деактивация программы
   - Ведение статистики обменов

4. **Безопасность:**
   - Проверки авторизации через admin_control
   - Защита от переполнений при математических операциях
   - Проверки наличия достаточных балансов
